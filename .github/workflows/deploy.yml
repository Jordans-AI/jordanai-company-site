name: Deploy to Hetzner

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '20'
  DEPLOY_PATH: '/opt/jordan-ai'

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build test
        run: npm run build
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          NEXT_PUBLIC_SITE_URL: https://jordan-ai.com

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://jordan-ai.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.HETZNER_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} "echo 'SSH connection successful'"

      - name: Create .env file on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            cat > ${{ env.DEPLOY_PATH }}/.env << 'ENVEOF'
          NODE_ENV=production
          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL=get-in-touch@notifications.jordan-ai.com
          RESEND_TO_EMAIL=shaylee@jordan-ai.com
          NEXT_PUBLIC_SITE_URL=https://jordan-ai.com
          NEXT_PUBLIC_APP_VERSION=${{ github.sha }}
          ENVEOF
          EOF

      - name: Deploy application
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.HETZNER_USER }}@${{ secrets.HETZNER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            bash deployment/scripts/deploy.sh
          EOF

      - name: Verify deployment
        run: |
          # Wait a bit for container to start
          sleep 10

          # Check if application is responding
          for i in {1..10}; do
            if curl -f https://jordan-ai.com/api/health; then
              echo "âœ… Deployment verified successfully!"
              exit 0
            fi
            echo "Waiting for application to respond... (attempt $i/10)"
            sleep 5
          done

          echo "âŒ Deployment verification failed"
          exit 1

      - name: Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check logs at: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  notify:
    name: Send notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Deployment status
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment to production successful!"
            echo "ðŸŒ Site: https://jordan-ai.com"
            echo "ðŸ“ Commit: ${{ github.sha }}"
            echo "ðŸ‘¤ Author: ${{ github.actor }}"
          else
            echo "âŒ Deployment failed"
          fi
